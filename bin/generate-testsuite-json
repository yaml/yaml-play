#!/usr/bin/env perl
# Generate JSON from yaml-test-suite data branch

use strict;
use warnings;
use JSON::PP;
use File::Basename;
use File::Spec;

my $testsuite_dir = $ARGV[0] or die "Usage: $0 <testsuite-dir>\n";
die "Directory not found: $testsuite_dir\n" unless -d $testsuite_dir;

my $json = JSON::PP->new->utf8->allow_nonref;

# Get current date for version
my @t = localtime;
my $version = sprintf("%04d.%02d.%02d", $t[5]+1900, $t[4]+1, $t[3]);

my @tests;

# Find all test directories (4-char alphanumeric IDs)
opendir(my $dh, $testsuite_dir) or die "Cannot open $testsuite_dir: $!\n";
my @dirs = sort grep { /^[A-Z0-9]{4}$/ && -d "$testsuite_dir/$_" } readdir($dh);
closedir($dh);

for my $base_id (@dirs) {
    my $base_dir = "$testsuite_dir/$base_id";

    # Check if this is a multi-test directory (has numbered subdirectories)
    opendir(my $sdh, $base_dir) or next;
    my @subdirs = sort grep { /^[0-9]{2}$/ && -d "$base_dir/$_" } readdir($sdh);
    closedir($sdh);

    if (@subdirs) {
        # Multi-test: iterate through numbered subdirectories
        for my $sub_id (@subdirs) {
            my $test = process_test("$base_id/$sub_id", "$base_dir/$sub_id");
            push @tests, $test if $test;
        }
    } else {
        # Single test: process directly
        my $test = process_test($base_id, $base_dir);
        push @tests, $test if $test;
    }
}

# Output JSON
print "{\n";
print "  \"version\": \"$version\",\n";
print "  \"tests\": [\n";
for my $i (0 .. $#tests) {
    my $comma = $i < $#tests ? "," : "";
    print "    " . $json->encode($tests[$i]) . "$comma\n";
}
print "  ]\n";
print "}\n";

sub process_test {
    my ($id, $test_dir) = @_;

    my $desc_file = "$test_dir/===";
    my $yaml_file = "$test_dir/in.yaml";

    return unless -f $desc_file && -f $yaml_file;

    # Read description
    my $desc = read_file($desc_file);
    $desc =~ s/\n//g;

    # Read YAML input
    my $yaml = read_file($yaml_file);

    # Read expected output
    my $event_file = "$test_dir/test.event";
    my $expected = -f $event_file ? read_file($event_file) : "";

    # Check if this is an error test
    my $is_error = -f "$test_dir/error" ? JSON::PP::true : JSON::PP::false;

    return {
        id => $id,
        name => $desc,
        error => $is_error,
        yaml => $yaml,
        expected => $expected,
    };
}

sub read_file {
    my ($file) = @_;
    open(my $fh, '<:encoding(UTF-8)', $file) or return "";
    local $/;
    my $content = <$fh>;
    close($fh);
    return $content;
}
