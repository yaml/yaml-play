#!/bin/bash
# Generate JSON from yaml-test-suite data branch

TESTSUITE_DIR="$1"

if [[ ! -d "$TESTSUITE_DIR" ]]; then
  echo "Usage: $0 <testsuite-dir>" >&2
  exit 1
fi

# Build list of error test IDs from tags/error directory
declare -A ERROR_TESTS
if [[ -d "$TESTSUITE_DIR/tags/error" ]]; then
  for id in "$TESTSUITE_DIR/tags/error"/*; do
    [[ -L "$id" ]] && ERROR_TESTS[$(basename "$id")]=1
  done
fi

echo '{'
echo "  \"version\": \"$(date +%Y.%m.%d)\","
echo '  "tests": ['

first=true
for dir in $(ls -d "$TESTSUITE_DIR"/[A-Z0-9][A-Z0-9][A-Z0-9][A-Z0-9] 2>/dev/null | sort); do
  [[ -d "$dir" ]] || continue
  id=$(basename "$dir")
  desc_file="$dir/==="
  yaml_file="$dir/in.yaml"

  [[ -f "$desc_file" ]] || continue
  [[ -f "$yaml_file" ]] || continue

  desc=$(cat "$desc_file" | tr -d '\n' | sed 's/"/\\"/g')
  yaml=$(cat "$yaml_file" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

  # Check if this is an error test
  is_error="false"
  [[ -n "${ERROR_TESTS[$id]}" ]] && is_error="true"

  if [[ "$first" == "true" ]]; then
    first=false
  else
    echo ','
  fi

  printf '    {"id": "%s", "name": "%s", "error": %s, "yaml": %s}' "$id" "$desc" "$is_error" "$yaml"
done

echo ''
echo '  ]'
echo '}'
